<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî Dyty Automobile</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    main{max-width:900px;margin:40px auto;padding:20px;background:#fff;border-radius:14px;border:1px solid #e3e3e3}
    form .row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    label{display:block;font-size:.9rem;margin-bottom:8px}
    input,textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #ddd;font:inherit}
    textarea{min-height:80px}
    .alert{padding:10px 12px;border-radius:8px;margin-bottom:15px;font-size:.9rem}
    .alert.error{background:#ffe6e6;color:#b30000}
    .alert.success{background:#e7f8ea;color:#116b2b}
    .btn{background:#bfa16a;border:none;color:#fff;padding:10px 18px;border-radius:999px;cursor:pointer;font-weight:600;margin-top:12px}
    .login-box{max-width:400px;margin:60px auto;padding:20px;background:#fff;border:1px solid #e3e3e3;border-radius:14px;text-align:center}
    .hint{display:block;margin-top:4px;font-size:.8rem;color:#6b6b6b}
    .admin-gallery-preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .admin-gallery-preview .gallery-chip{position:relative;width:90px;height:90px;border-radius:12px;overflow:hidden;border:1px solid #d8d8d8;background:#f9f9f9}
    .admin-gallery-preview .gallery-chip img{width:100%;height:100%;object-fit:cover}
    .admin-gallery-preview .gallery-chip button{position:absolute;top:4px;right:4px;border:none;background:rgba(0,0,0,.6);color:#fff;border-radius:6px;padding:2px 6px;font-size:.7rem;cursor:pointer}
    .admin-gallery-preview .gallery-chip button:hover{background:rgba(0,0,0,.75)}
  </style>
</head>
<body>
<header class="header">
  <div class="container header-inner">
    <a class="logo" href="index.html#accueil">Dyty Automobile</a>
    <nav class="nav">
      <a href="index.html#stock">Voir le site</a>
    </nav>
  </div>
</header>

<div id="appRoot">
  <!-- contenu g√©r√© en JS -->
</div>

<script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
  
    const supabaseUrl = 'https://vosmwhlwkbwkczmwmitx.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZvc213aGx3a2J3a2N6bXdtaXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNjk4MTMsImV4cCI6MjA3Nzk0NTgxM30.fyvgpiYuZHBpsT6X1Zfs1Z_ALxIndnBFW8N5QcU5yo8';
    const supabase = createClient(supabaseUrl, supabaseKey);
  
    const root = document.getElementById('appRoot');
    let adminCarsCache = []; // m√©morise les voitures charg√©es pour pouvoir les √©diter
    let galleryColumnDetected = false;
  
    // V√©rifie si une session existe d√©j√†
    async function checkSession() {
      const { data } = await supabase.auth.getSession();
      if (data && data.session) {
        renderAdmin(data.session.user);
      } else {
        renderLogin();
      }
    }
  
    // Vue de connexion
    function renderLogin(message = '') {
      root.innerHTML = `
        <div class="login-box">
          <h1>Connexion admin</h1>
          ${message ? `<div class="alert error">${message}</div>` : ''}
          <form id="loginForm">
            <label>Email
              <input type="email" name="email" required>
            </label>
            <label>Mot de passe
              <input type="password" name="password" required>
            </label>
            <button type="submit" class="btn">Se connecter</button>
          </form>
        </div>
      `;
  
      const form = document.getElementById('loginForm');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = form.email.value;
        const password = form.password.value;
  
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  
        if (error) {
          console.error(error);
          renderLogin("Identifiants incorrects ou erreur de connexion.");
        } else {
          renderAdmin(data.user);
        }
      });
    }
  
    // Vue admin (formulaire + liste)
    function renderAdmin(user) {
      root.innerHTML = `
        <main>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <h1>Admin ‚Äî V√©hicules</h1>
            <button id="logoutBtn" class="btn" style="background:#999;">Se d√©connecter</button>
          </div>
  
          <div id="msgBox"></div>
  
          <form id="carForm">
            <!-- ID cach√© pour savoir si on est en mode AJOUT ou MODIF -->
            <input type="hidden" name="id" />
  
            <div class="row">
              <label>Marque
                <input type="text" name="marque" required>
              </label>
              <label>Mod√®le
                <input type="text" name="modele" required>
              </label>
              <label>Ann√©e
                <input type="number" name="annee" required>
              </label>
              <label>Kilom√©trage
                <input type="number" name="kilometrage" required>
              </label>
              <label>Prix (‚Ç¨)
                <input type="number" name="prix" required>
              </label>
              <label>Carburant
                <input type="text" name="carburant" placeholder="Diesel, Essence, Hybride‚Ä¶" required>
              </label>
              <label>Bo√Æte
                <input type="text" name="boite" placeholder="Manuelle, Automatique‚Ä¶" required>
              </label>
              <label>Motorisation
                <input type="text" name="motorisation" placeholder="Ex : 1.5 TSI 150">
              </label>
              <label>Nombre de chevaux
                <input type="number" name="chevaux" placeholder="Ex : 150">
              </label>
              <label>Couleur
                <input type="text" name="couleur">
              </label>
              <label>Image du v√©hicule
                <input type="file" name="image_file" accept="image/*">
              </label>
            </div>

            <label>Description courte
              <textarea name="description_courte" placeholder="Ex : Premi√®re main, entretien suivi..."></textarea>
            </label>

            <label>√âquipements & options
              <textarea name="options" placeholder="GPS, Cam√©ra de recul, Sellerie cuir..."></textarea>
            </label>

            <label>Images suppl√©mentaires (galerie)
              <input type="file" name="gallery_files" accept="image/*" multiple>
              <span class="hint">Tu peux s√©lectionner plusieurs fichiers¬†: ils s‚Äôajouteront √† la galerie du v√©hicule.</span>
            </label>
            <div id="galleryPreview" class="admin-gallery-preview" aria-live="polite"></div>

            <div style="display:flex;gap:8px;align-items:center;margin-top:10px;">
              <button type="submit" id="submitBtn" class="btn">Ajouter le v√©hicule</button>
              <button type="button" id="cancelEditBtn" class="btn" style="background:#ddd;display:none;">Annuler la modification</button>
            </div>
          </form>
  
          <hr style="margin:30px 0;border:none;border-top:1px solid #eee;" />
  
          <h2 style="margin-bottom:10px;">Liste des v√©hicules</h2>
          <p style="font-size:.9rem;color:#666;margin-top:0;">
            Tu peux <strong>modifier</strong>, <strong>marquer comme vendu</strong> ou <strong>supprimer</strong> une annonce d√©j√† publi√©e ‚ú®
          </p>
          <div id="adminCars"></div>
        </main>
      `;
  
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await supabase.auth.signOut();
        renderLogin();
      });
  
      const form = document.getElementById('carForm');
      const msgBox = document.getElementById('msgBox');
      const submitBtn = document.getElementById('submitBtn');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const galleryPreview = document.getElementById('galleryPreview');
      const galleryInput = form.querySelector('input[name="gallery_files"]');

      function normalizeGallery(value) {
        if (!value) return [];
        if (Array.isArray(value)) return value.filter(Boolean);
        if (typeof value === 'string') {
          try {
            const parsed = JSON.parse(value);
            if (Array.isArray(parsed)) return parsed.filter(Boolean);
          } catch (err) {
            // fallback: split by separators
          }
          return value
            .split(/[\n;,|]+/)
            .map((s) => s.trim())
            .filter(Boolean);
        }
        return [];
      }

      function getCurrentGallery() {
        try {
          const raw = form.dataset.currentGallery || '[]';
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed.filter(Boolean) : [];
        } catch (err) {
          return [];
        }
      }

      function updateGalleryPreview(urls = []) {
        if (!galleryPreview) return;
        const safeUrls = Array.isArray(urls) ? urls.filter(Boolean) : [];
        form.dataset.currentGallery = JSON.stringify(safeUrls);

        if (!safeUrls.length) {
          galleryPreview.innerHTML = '<p class="hint" style="margin:0;">Aucune image dans la galerie pour le moment.</p>';
          return;
        }

        galleryPreview.innerHTML = safeUrls
          .map((url, index) => `
            <div class="gallery-chip">
              <img src="${url}" alt="Photo suppl√©mentaire ${index + 1}">
              <button type="button" data-remove-gallery="${index}" aria-label="Retirer cette photo">&times;</button>
            </div>
          `)
          .join('');
      }

      if (galleryPreview) {
        galleryPreview.addEventListener('click', (event) => {
          const btn = event.target.closest('[data-remove-gallery]');
          if (!btn) return;
          event.preventDefault();
          const index = Number(btn.getAttribute('data-remove-gallery'));
          if (Number.isNaN(index)) return;
          const urls = getCurrentGallery();
          urls.splice(index, 1);
          updateGalleryPreview(urls);
        });
      }
  
      // ID de la voiture en cours d‚Äô√©dition (ou null si ajout)
      let editingCarId = null;
  
      // pour garder l‚Äôancienne image si on n‚Äôen uploade pas une nouvelle
      form.dataset.currentImageUrl = '';
  
      function resetFormMode() {
        editingCarId = null;
        form.reset();
        form.id.value = '';
        form.dataset.currentImageUrl = '';
        form.dataset.currentGallery = '[]';
        submitBtn.textContent = 'Ajouter le v√©hicule';
        cancelEditBtn.style.display = 'none';
        updateGalleryPreview([]);
      }

      cancelEditBtn.addEventListener('click', () => {
        resetFormMode();
      });

      updateGalleryPreview([]);
  
      // Soumission formulaire (ajout OU modification)
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        msgBox.innerHTML = '';
  
        const fileInput = form.querySelector('input[name="image_file"]');
        const file = fileInput.files[0];
        const galleryFiles = galleryInput ? Array.from(galleryInput.files || []) : [];

        let galleryUrls = getCurrentGallery();

        let imageUrl = form.dataset.currentImageUrl || null;
  
        // Upload de l'image si on en a s√©lectionn√© une nouvelle
        if (file) {
          const ext = file.name.includes('.') ? file.name.split('.').pop() : 'jpg';
          const fileName = `${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
          const filePath = `vehicules/${fileName}`;
  
          const { error: uploadError } = await supabase
            .storage
            .from('voitures')
            .upload(filePath, file);
  
          if (uploadError) {
            console.error(uploadError);
            msgBox.innerHTML = `<div class="alert error">Erreur lors de l‚Äôupload de l‚Äôimage.</div>`;
            return;
          }
  
          const { data: publicData } = supabase
            .storage
            .from('voitures')
            .getPublicUrl(filePath);
  
          imageUrl = publicData.publicUrl;
        }

        if (galleryFiles.length) {
          for (const gf of galleryFiles) {
            const ext = gf.name.includes('.') ? gf.name.split('.').pop() : 'jpg';
            const fileName = `${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
            const filePath = `vehicules/${fileName}`;

            const { error: uploadError } = await supabase
              .storage
              .from('voitures')
              .upload(filePath, gf);

            if (uploadError) {
              console.error(uploadError);
              msgBox.innerHTML = `<div class="alert error">Erreur lors de l‚Äôupload d‚Äôune image de galerie.</div>`;
              return;
            }

            const { data: publicData } = supabase
              .storage
              .from('voitures')
              .getPublicUrl(filePath);

            if (publicData?.publicUrl) {
              galleryUrls.push(publicData.publicUrl);
            }
          }

          updateGalleryPreview(galleryUrls);
          if (galleryInput) galleryInput.value = '';
        }

        const payload = {
          marque: form.marque.value.trim(),
          modele: form.modele.value.trim(),
          annee: Number(form.annee.value),
          kilometrage: Number(form.kilometrage.value),
          prix: Number(form.prix.value),
          carburant: form.carburant.value.trim(),
          boite: form.boite.value.trim(),
          motorisation: form.motorisation.value.trim() || null,
          chevaux: form.chevaux.value ? Number(form.chevaux.value) : null,
          couleur: form.couleur.value.trim() || null,
          image_url: imageUrl,
          description_courte: form.description_courte.value.trim() || null,
          options: form.options.value.trim() || null,
        };

        if (galleryColumnDetected || galleryUrls.length) {
          payload.gallery_urls = galleryUrls;
        }

        let error;
  
        if (editingCarId) {
          // üîÅ MODE MODIFICATION
          ({ error } = await supabase
            .from('voitures')
            .update(payload)
            .eq('id', editingCarId));
        } else {
          // ‚ú® MODE AJOUT (non vendu par d√©faut)
          ({ error } = await supabase
            .from('voitures')
            .insert({ ...payload, vendu: false }));
        }
  
        if (error) {
          console.error(error);
          msgBox.innerHTML = `<div class="alert error">Erreur lors de l‚Äôenregistrement du v√©hicule.</div>`;
        } else {
          msgBox.innerHTML = `<div class="alert success">V√©hicule enregistr√© avec succ√®s ‚ú®</div>`;
          resetFormMode();
          loadAdminCars({ onEdit: handleEdit }); // on recharge la liste apr√®s ajout/modif
        }
      });
  
      // Callback appel√©e quand on clique sur "Modifier" dans la liste
      function handleEdit(car) {
        editingCarId = car.id;
        form.id.value = car.id;
        form.marque.value = car.marque || '';
        form.modele.value = car.modele || '';
        form.annee.value = car.annee || '';
        form.kilometrage.value = car.kilometrage || '';
        form.prix.value = car.prix || '';
        form.carburant.value = car.carburant || '';
        form.boite.value = car.boite || '';
        form.motorisation.value = car.motorisation || '';
        form.chevaux.value = car.chevaux || '';
        form.couleur.value = car.couleur || '';
        form.description_courte.value = car.description_courte || '';
        form.options.value = car.options || '';
        form.dataset.currentImageUrl = car.image_url || '';
        updateGalleryPreview(normalizeGallery(car.gallery_urls));

        submitBtn.textContent = 'Mettre √† jour le v√©hicule';
        cancelEditBtn.style.display = 'inline-block';

        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
  
      // Premier chargement de la liste
      loadAdminCars({ onEdit: handleEdit });
    }
  
    // Charge la liste des v√©hicules pour l‚Äôadmin
    async function loadAdminCars({ onEdit } = {}) {
      const container = document.getElementById('adminCars');
      if (!container) return;
  
      const { data, error } = await supabase
        .from('voitures')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error(error);
        container.innerHTML = '<p>Erreur lors du chargement des v√©hicules.</p>';
        return;
      }

      adminCarsCache = data || [];
      galleryColumnDetected = (data || []).some((v) => Object.prototype.hasOwnProperty.call(v, 'gallery_urls'));
  
      if (!data || data.length === 0) {
        container.innerHTML = '<p>Aucun v√©hicule enregistr√© pour le moment.</p>';
        return;
      }
  
      container.innerHTML = '';
  
      data.forEach((v) => {
        const div = document.createElement('div');
        div.style.padding = '10px 12px';
        div.style.border = '1px solid #eee';
        div.style.borderRadius = '10px';
        div.style.marginBottom = '8px';
        div.style.display = 'flex';
        div.style.justifyContent = 'space-between';
        div.style.alignItems = 'center';
        div.style.gap = '10px';
  
        div.innerHTML = `
          <div style="flex:1;">
            <strong>${v.marque} ${v.modele}</strong>
            <span style="color:#777;font-size:.9rem;">
              ‚Ä¢ ${v.annee} ‚Ä¢ ${Number(v.kilometrage).toLocaleString('fr-FR')} km
            </span>
            ${
              v.motorisation || v.chevaux
                ? `<div style="font-size:.85rem;color:#555;margin-top:4px;">
                    ${v.motorisation ? `${v.motorisation}` : ''}
                    ${v.motorisation && v.chevaux ? ' ‚Ä¢ ' : ''}
                    ${v.chevaux ? `${v.chevaux} ch` : ''}
                  </div>`
                : ''
            }
            ${v.vendu ? '<span style="margin-left:8px;padding:2px 8px;border-radius:999px;background:#fce4e4;color:#b30000;font-size:.8rem;">Vendu</span>' : ''}
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button
              class="btn"
              style="padding:6px 10px;font-size:.8rem;background:#607D8B;"
              data-action="edit"
              data-id="${v.id}"
            >
              Modifier
            </button>
            <button
              class="btn"
              style="padding:6px 10px;font-size:.8rem;${v.vendu ? 'background:#4caf50;' : 'background:#bfa16a;'}"
              data-action="toggle-sold"
              data-id="${v.id}"
            >
              ${v.vendu ? 'Remettre en vente' : 'Marquer comme vendu'}
            </button>
            <button
              class="btn"
              style="padding:6px 10px;font-size:.8rem;background:#c62828;"
              data-action="delete"
              data-id="${v.id}"
            >
              Supprimer
            </button>
          </div>
        `;
  
        container.appendChild(div);
      });
  
      // Bouton Modifier
      if (onEdit) {
        container.querySelectorAll('button[data-action="edit"]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-id');
            const car = adminCarsCache.find((c) => String(c.id) === String(id));
            if (car) onEdit(car);
          });
        });
      }
  
      // Bouton Marquer comme vendu / Remettre en vente
      container.querySelectorAll('button[data-action="toggle-sold"]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const car = adminCarsCache.find((c) => String(c.id) === String(id));
          if (!car) return;
          await setCarSold(id, !car.vendu);
        });
      });
  
      // Bouton Supprimer
      container.querySelectorAll('button[data-action="delete"]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          if (confirm('Supprimer d√©finitivement ce v√©hicule ?')) {
            await deleteCar(id);
          }
        });
      });
    }
  
    // Met √† jour le statut vendu
    async function setCarSold(id, isSold) {
      const { error } = await supabase
        .from('voitures')
        .update({ vendu: isSold })
        .eq('id', id);
  
      if (error) {
        alert("Erreur lors de la mise √† jour du statut.");
        console.error(error);
      } else {
        loadAdminCars(); // pas besoin de callback ici, juste refresh visuel
      }
    }
  
    // Supprime un v√©hicule
    async function deleteCar(id) {
      const { error } = await supabase
        .from('voitures')
        .delete()
        .eq('id', id);
  
      if (error) {
        alert("Erreur lors de la suppression.");
        console.error(error);
      } else {
        loadAdminCars();
      }
    }
  
    // Lancement
    checkSession();
  </script>
  