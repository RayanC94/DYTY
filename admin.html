<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî Dyty Automobile</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    main{max-width:900px;margin:40px auto;padding:20px;background:#fff;border-radius:14px;border:1px solid #e3e3e3}
    form .row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    label{display:block;font-size:.9rem;margin-bottom:8px}
    input,textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #ddd;font:inherit}
    textarea{min-height:80px}
    .alert{padding:10px 12px;border-radius:8px;margin-bottom:15px;font-size:.9rem}
    .alert.error{background:#ffe6e6;color:#b30000}
    .alert.success{background:#e7f8ea;color:#116b2b}
    .btn{background:#bfa16a;border:none;color:#fff;padding:10px 18px;border-radius:999px;cursor:pointer;font-weight:600;margin-top:12px}
    .login-box{max-width:400px;margin:60px auto;padding:20px;background:#fff;border:1px solid #e3e3e3;border-radius:14px;text-align:center}
    .hint{display:block;margin-top:4px;font-size:.8rem;color:#6b6b6b}
    .admin-gallery-preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .admin-gallery-preview .gallery-chip{position:relative;width:90px;height:90px;border-radius:12px;overflow:hidden;border:1px solid #d8d8d8;background:#f9f9f9}
    .admin-gallery-preview .gallery-chip img{width:100%;height:100%;object-fit:cover}
    .admin-gallery-preview .gallery-chip button{position:absolute;top:4px;right:4px;border:none;background:rgba(0,0,0,.6);color:#fff;border-radius:6px;padding:2px 6px;font-size:.7rem;cursor:pointer}
    .admin-gallery-preview .gallery-chip button:hover{background:rgba(0,0,0,.75)}

    /* Dashboard + filtres */
    .admin-dashboard{display:flex;flex-direction:column;gap:18px;margin:24px 0}
    .admin-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .admin-stat-card{padding:16px;border:1px solid #ececec;border-radius:12px;background:#faf9f6}
    .admin-stat-card h3{margin:0;font-size:.85rem;font-weight:600;color:#7a6a49;text-transform:uppercase;letter-spacing:.04em}
    .admin-stat-card strong{display:block;margin-top:6px;font-size:1.6rem;color:#2d2a26}
    .admin-filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .admin-filters label{margin:0;font-size:.85rem;color:#444}
    .admin-filters input,.admin-filters select{width:auto;min-width:180px;padding:8px 12px;border-radius:999px;border:1px solid #d6d6d6;background:#fff;font:inherit}
    .admin-filters input{flex:1;min-width:220px}
    .admin-stat-sub{display:block;margin-top:4px;font-size:.8rem;color:#6b6b6b}
    .admin-contacts{display:flex;flex-direction:column;gap:12px;margin-top:30px;padding:20px;border:1px solid #ececec;border-radius:12px;background:#faf9f6}
    .admin-contacts-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .admin-contacts-hint{margin:0;color:#555;font-size:.9rem}
    .admin-contacts-loading{padding:12px;border-radius:10px;background:#fff;border:1px dashed #d6d6d6;color:#7a6a49;font-weight:600;font-size:.9rem}
    .admin-contacts-empty{margin:0;color:#777;font-size:.9rem}
    .admin-contact-list{display:flex;flex-direction:column;gap:10px}
    .admin-contact-card{border:1px solid #e3e3e3;border-radius:12px;padding:14px;background:#fff;display:flex;flex-direction:column;gap:8px}
    .admin-contact-card header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .admin-contact-card h3{margin:0;font-size:1rem;color:#2d2a26}
    .admin-contact-meta{margin:0;font-size:.85rem;color:#777}
    .admin-contact-body{display:grid;gap:6px;font-size:.9rem;color:#444}
    .admin-contact-body a{color:#607D8B;text-decoration:none}
    .admin-contact-body a:hover{text-decoration:underline}
    .admin-contact-actions{display:flex;gap:8px;flex-wrap:wrap}
    .admin-contact-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:.75rem;font-weight:600}
    .admin-contact-badge.pending{background:#fff4d8;color:#b3842c}
    .admin-contact-badge.processed{background:#e7f8ea;color:#116b2b}
  </style>
</head>
<body>
<header class="header">
  <div class="container header-inner">
    <a class="logo" href="index.html#accueil">Dyty Automobile</a>
    <nav class="nav">
      <a href="index.html#stock">Voir le site</a>
    </nav>
  </div>
</header>

<div id="appRoot">
  <!-- contenu g√©r√© en JS -->
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
  
  const supabaseUrl = 'https://vosmwhlwkbwkczmwmitx.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZvc213aGx3a2J3a2N6bXdtaXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNjk4MTMsImV4cCI6MjA3Nzk0NTgxM30.fyvgpiYuZHBpsT6X1Zfs1Z_ALxIndnBFW8N5QcU5yo8';
  const supabase = createClient(supabaseUrl, supabaseKey);
  
  const root = document.getElementById('appRoot');
  let adminCarsCache = []; // m√©morise les voitures charg√©es pour pouvoir les √©diter
  let galleryColumnDetected = false;
  let adminFilters = { search: '', status: 'all' };
  let currentOnEditCallback = null;
  let contactRequestsCache = [];
  
  // V√©rifie si une session existe d√©j√†
  async function checkSession() {
    const { data } = await supabase.auth.getSession();
    if (data && data.session) {
      renderAdmin(data.session.user);
    } else {
      renderLogin();
    }
  }
  
  // Vue de connexion
  function renderLogin(message = '') {
    root.innerHTML = `
      <div class="login-box">
        <h1>Connexion admin</h1>
        ${message ? `<div class="alert error">${message}</div>` : ''}
        <form id="loginForm">
          <label>Email
            <input type="email" name="email" required>
          </label>
          <label>Mot de passe
            <input type="password" name="password" required>
          </label>
          <button type="submit" class="btn">Se connecter</button>
        </form>
      </div>
    `;
  
    const form = document.getElementById('loginForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = form.email.value;
      const password = form.password.value;
  
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  
      if (error) {
        console.error(error);
        renderLogin("Identifiants incorrects ou erreur de connexion.");
      } else {
        renderAdmin(data.user);
      }
    });
  }

  function escapeHtml(value = '') {
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function formatContactDate(value) {
    if (!value) return '';
    try {
      const date = new Date(value);
      return date.toLocaleString('fr-FR', {
        dateStyle: 'short',
        timeStyle: 'short',
      });
    } catch (err) {
      return String(value);
    }
  }

  function formatPhoneHref(value = '') {
    return `tel:${String(value).replace(/[^+\d]/g, '')}`;
  }

  // Vue admin (formulaire + liste)
  function renderAdmin(user) {
    root.innerHTML = `
      <main>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <h1>Admin ‚Äî V√©hicules</h1>
          <button id="logoutBtn" class="btn" style="background:#999;">Se d√©connecter</button>
        </div>
  
        <div id="msgBox"></div>

        <!-- Dashboard + filtres -->
        <section class="admin-dashboard" aria-label="Aper√ßu du stock">
          <div id="dashboardStats" class="admin-stats-grid">
            <div class="admin-stat-card">
              <h3>Total annonces</h3>
              <strong id="statTotal">0</strong>
            </div>
            <div class="admin-stat-card">
              <h3>En vitrine</h3>
              <strong id="statAvailable">0</strong>
            </div>
            <div class="admin-stat-card">
              <h3>Vendues</h3>
              <strong id="statSold">0</strong>
            </div>
            <div class="admin-stat-card">
              <h3>R√©serv√©es</h3>
              <strong id="statReserved">0</strong>
            </div>
            <div class="admin-stat-card">
              <h3>Demandes contact</h3>
              <strong id="statContacts">0</strong>
              <span class="admin-stat-sub" id="statContactsTotal">Total 0</span>
            </div>
          </div>

          <div class="admin-filters" role="search" aria-label="Filtrer les annonces">
            <label for="adminSearch">Rechercher</label>
            <input type="search" id="adminSearch" name="search" placeholder="Marque, mod√®le, ann√©e..." />

            <label for="statusFilter">Statut</label>
            <select id="statusFilter" name="status">
              <option value="all">Tous</option>
              <option value="available">En vitrine</option>
              <option value="sold">Vendues</option>
              <option value="reserved">R√©serv√©es</option>
            </select>
          </div>
        </section>
  
        <form id="carForm">
          <!-- ID cach√© pour savoir si on est en mode AJOUT ou MODIF -->
          <input type="hidden" name="id" />
  
          <div class="row">
            <label>Marque
              <input type="text" name="marque" required>
            </label>
            <label>Mod√®le
              <input type="text" name="modele" required>
            </label>
            <label>Ann√©e
              <input type="number" name="annee" required>
            </label>
            <label>Kilom√©trage
              <input type="number" name="kilometrage" required>
            </label>
            <label>Prix (‚Ç¨)
              <input type="number" name="prix" required>
            </label>
            <label>Carburant
              <input type="text" name="carburant" placeholder="Diesel, Essence, Hybride‚Ä¶" required>
            </label>
            <label>Bo√Æte
              <input type="text" name="boite" placeholder="Manuelle, Automatique‚Ä¶" required>
            </label>
            <label>Motorisation
              <input type="text" name="motorisation" placeholder="Ex : 1.5 TSI 150">
            </label>
            <label>Nombre de chevaux
              <input type="number" name="chevaux" placeholder="Ex : 150">
            </label>
            <label>Couleur
              <input type="text" name="couleur">
            </label>
            <label>Image du v√©hicule
              <input type="file" name="image_file" accept="image/*">
            </label>
          </div>

          <label>Description courte
            <textarea name="description_courte" placeholder="Ex : Premi√®re main, entretien suivi..."></textarea>
          </label>

          <label>√âquipements & options
            <textarea name="options" placeholder="GPS, Cam√©ra de recul, Sellerie cuir..."></textarea>
          </label>

          <label>Images suppl√©mentaires (galerie)
            <input type="file" name="gallery_files" accept="image/*" multiple>
            <span class="hint">Tu peux s√©lectionner plusieurs fichiers : ils s‚Äôajouteront √† la galerie du v√©hicule.</span>
          </label>
          <div id="galleryPreview" class="admin-gallery-preview" aria-live="polite"></div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:10px;">
            <button type="submit" id="submitBtn" class="btn">Ajouter le v√©hicule</button>
            <button type="button" id="cancelEditBtn" class="btn" style="background:#ddd;display:none;">Annuler la modification</button>
          </div>
        </form>
  
        <hr style="margin:30px 0;border:none;border-top:1px solid #eee;" />
  
        <h2 style="margin-bottom:10px;">Liste des v√©hicules</h2>
        <p style="font-size:.9rem;color:#666;margin-top:0;">
          Tu peux <strong>modifier</strong>, <strong>marquer comme vendu</strong> ou <strong>supprimer</strong> une annonce d√©j√† publi√©e ‚ú®
        </p>
        <div id="adminCars"></div>

        <section class="admin-contacts" aria-labelledby="contactRequestsTitle">
          <div class="admin-contacts-header">
            <h2 id="contactRequestsTitle">Demandes de contact</h2>
            <button type="button" id="refreshContactsBtn" class="btn" style="background:#607D8B;">Actualiser</button>
          </div>
          <p class="admin-contacts-hint">Derni√®res demandes re√ßues via le formulaire du site.</p>
          <div id="contactsError" class="alert error" hidden></div>
          <div id="contactsLoading" class="admin-contacts-loading" hidden>Chargement des demandes‚Ä¶</div>
          <div id="adminContacts" class="admin-contact-list" role="list"></div>
          <p id="contactsEmpty" class="admin-contacts-empty" hidden>Aucune demande pour le moment.</p>
        </section>
      </main>
    `;
  
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      renderLogin();
    });
  
    const form = document.getElementById('carForm');
    const msgBox = document.getElementById('msgBox');
    const submitBtn = document.getElementById('submitBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const galleryPreview = document.getElementById('galleryPreview');
    const galleryInput = form.querySelector('input[name="gallery_files"]');
    const searchInput = document.getElementById('adminSearch');
    const statusFilter = document.getElementById('statusFilter');
    const refreshContactsBtn = document.getElementById('refreshContactsBtn');
    const contactList = document.getElementById('adminContacts');

    if (searchInput) {
      searchInput.value = adminFilters.search;
      searchInput.addEventListener('input', () => {
        adminFilters.search = searchInput.value;
        refreshAdminList();
      });
    }

    if (statusFilter) {
      statusFilter.value = adminFilters.status;
      statusFilter.addEventListener('change', () => {
        adminFilters.status = statusFilter.value;
        refreshAdminList();
      });
    }

    if (refreshContactsBtn) {
      refreshContactsBtn.addEventListener('click', () => {
        loadContacts({ showLoader: true });
      });
    }

    if (contactList) {
      contactList.addEventListener('click', async (event) => {
        const btn = event.target.closest('[data-contact-toggle]');
        if (!btn) return;

        const id = btn.getAttribute('data-contact-toggle');
        const processed = btn.getAttribute('data-processed') === 'true';

        btn.disabled = true;
        const originalText = btn.dataset.originalText || btn.textContent;
        btn.dataset.originalText = originalText;
        btn.textContent = 'Mise √† jour‚Ä¶';

        const { error } = await supabase
          .from('contacts')
          .update({ processed: !processed })
          .eq('id', id);

        if (error) {
          console.error(error);
          showContactsError("Impossible de mettre √† jour la demande.");
          btn.disabled = false;
          btn.textContent = originalText;
          return;
        }

        showContactsError('');
        await loadContacts({ showLoader: false });
      });
    }

    function refreshAdminList() {
      renderAdminList(getFilteredCars(), { onEdit: handleEdit });
    }

    function normalizeGallery(value) {
      if (!value) return [];
      if (Array.isArray(value)) return value.filter(Boolean);
      if (typeof value === 'string') {
        try {
          const parsed = JSON.parse(value);
          if (Array.isArray(parsed)) return parsed.filter(Boolean);
        } catch (err) {
          // fallback: split by separators
        }
        return value
          .split(/[\n;,|]+/)
          .map((s) => s.trim())
          .filter(Boolean);
      }
      return [];
    }

    function getCurrentGallery() {
      try {
        const raw = form.dataset.currentGallery || '[]';
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed.filter(Boolean) : [];
      } catch (err) {
        return [];
      }
    }

    function updateGalleryPreview(urls = []) {
      if (!galleryPreview) return;
      const safeUrls = Array.isArray(urls) ? urls.filter(Boolean) : [];
      form.dataset.currentGallery = JSON.stringify(safeUrls);

      if (!safeUrls.length) {
        galleryPreview.innerHTML = '<p class="hint" style="margin:0;">Aucune image dans la galerie pour le moment.</p>';
        return;
      }

      galleryPreview.innerHTML = safeUrls
        .map((url, index) => `
          <div class="gallery-chip">
            <img src="${url}" alt="Photo suppl√©mentaire ${index + 1}">
            <button type="button" data-remove-gallery="${index}" aria-label="Retirer cette photo">&times;</button>
          </div>
        `)
        .join('');
    }

    if (galleryPreview) {
      galleryPreview.addEventListener('click', (event) => {
        const btn = event.target.closest('[data-remove-gallery]');
        if (!btn) return;
        event.preventDefault();
        const index = Number(btn.getAttribute('data-remove-gallery'));
        if (Number.isNaN(index)) return;
        const urls = getCurrentGallery();
        urls.splice(index, 1);
        updateGalleryPreview(urls);
      });
    }
  
    // ID de la voiture en cours d‚Äô√©dition (ou null si ajout)
    let editingCarId = null;
  
    // pour garder l‚Äôancienne image si on n‚Äôen uploade pas une nouvelle
    form.dataset.currentImageUrl = '';
  
    function resetFormMode() {
      editingCarId = null;
      form.reset();
      form.id.value = '';
      form.dataset.currentImageUrl = '';
      form.dataset.currentGallery = '[]';
      submitBtn.textContent = 'Ajouter le v√©hicule';
      cancelEditBtn.style.display = 'none';
      updateGalleryPreview([]);
    }

    cancelEditBtn.addEventListener('click', () => {
      resetFormMode();
    });

    updateGalleryPreview([]);
  
    // Soumission formulaire (ajout OU modification)
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msgBox.innerHTML = '';
  
      const fileInput = form.querySelector('input[name="image_file"]');
      const file = fileInput.files[0];
      const galleryFiles = galleryInput ? Array.from(galleryInput.files || []) : [];

      let galleryUrls = getCurrentGallery();
      let imageUrl = form.dataset.currentImageUrl || null;
  
      // Upload de l'image si on en a s√©lectionn√© une nouvelle
      if (file) {
        const ext = file.name.includes('.') ? file.name.split('.').pop() : 'jpg';
        const fileName = `${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
        const filePath = `vehicules/${fileName}`;
  
        const { error: uploadError } = await supabase
          .storage
          .from('voitures')
          .upload(filePath, file);
  
        if (uploadError) {
          console.error(uploadError);
          msgBox.innerHTML = `<div class="alert error">Erreur lors de l‚Äôupload de l‚Äôimage.</div>`;
          return;
        }
  
        const { data: publicData } = supabase
          .storage
          .from('voitures')
          .getPublicUrl(filePath);
  
        imageUrl = publicData.publicUrl;
      }

      // Upload des images de galerie
      if (galleryFiles.length) {
        for (const gf of galleryFiles) {
          const ext = gf.name.includes('.') ? gf.name.split('.').pop() : 'jpg';
          const fileName = `${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
          const filePath = `vehicules/${fileName}`;

          const { error: uploadError } = await supabase
            .storage
            .from('voitures')
            .upload(filePath, gf);

          if (uploadError) {
            console.error(uploadError);
            msgBox.innerHTML = `<div class="alert error">Erreur lors de l‚Äôupload d‚Äôune image de galerie.</div>`;
            return;
          }

          const { data: publicData } = supabase
            .storage
            .from('voitures')
            .getPublicUrl(filePath);

          if (publicData?.publicUrl) {
            galleryUrls.push(publicData.publicUrl);
          }
        }

        updateGalleryPreview(galleryUrls);
        if (galleryInput) galleryInput.value = '';
      }

      const payload = {
        marque: form.marque.value.trim(),
        modele: form.modele.value.trim(),
        annee: Number(form.annee.value),
        kilometrage: Number(form.kilometrage.value),
        prix: Number(form.prix.value),
        carburant: form.carburant.value.trim(),
        boite: form.boite.value.trim(),
        motorisation: form.motorisation.value.trim() || null,
        chevaux: form.chevaux.value ? Number(form.chevaux.value) : null,
        couleur: form.couleur.value.trim() || null,
        image_url: imageUrl,
        description_courte: form.description_courte.value.trim() || null,
        options: form.options.value.trim() || null,
      };

      // ‚ú® IMPORTANT : on n‚Äôenvoie gallery_urls QUE si la colonne existe vraiment
      if (galleryColumnDetected) {
        payload.gallery_urls = galleryUrls;
      }

      let error;
  
      if (editingCarId) {
        // üîÅ MODE MODIFICATION
        ({ error } = await supabase
          .from('voitures')
          .update(payload)
          .eq('id', editingCarId));
      } else {
        // ‚ú® MODE AJOUT (non vendu par d√©faut)
        ({ error } = await supabase
          .from('voitures')
          .insert({ ...payload, vendu: false }));
      }
  
      if (error) {
        console.error(error);
        msgBox.innerHTML = `<div class="alert error">Erreur lors de l‚Äôenregistrement du v√©hicule.</div>`;
      } else {
        msgBox.innerHTML = `<div class="alert success">V√©hicule enregistr√© avec succ√®s ‚ú®</div>`;
        resetFormMode();
        loadAdminCars({ onEdit: handleEdit }); // on recharge la liste apr√®s ajout/modif
      }
    });
  
    // Callback appel√©e quand on clique sur "Modifier" dans la liste
    function handleEdit(car) {
      editingCarId = car.id;
      form.id.value = car.id;
      form.marque.value = car.marque || '';
      form.modele.value = car.modele || '';
      form.annee.value = car.annee || '';
      form.kilometrage.value = car.kilometrage || '';
      form.prix.value = car.prix || '';
      form.carburant.value = car.carburant || '';
      form.boite.value = car.boite || '';
      form.motorisation.value = car.motorisation || '';
      form.chevaux.value = car.chevaux || '';
      form.couleur.value = car.couleur || '';
      form.description_courte.value = car.description_courte || '';
      form.options.value = car.options || '';
      form.dataset.currentImageUrl = car.image_url || '';
      updateGalleryPreview(normalizeGallery(car.gallery_urls));

      submitBtn.textContent = 'Mettre √† jour le v√©hicule';
      cancelEditBtn.style.display = 'inline-block';

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  
    // Premier chargement de la liste
    loadAdminCars({ onEdit: handleEdit });
    loadContacts();
  }

  function showContactsError(message = '') {
    const errorEl = document.getElementById('contactsError');
    if (!errorEl) return;
    if (!message) {
      errorEl.hidden = true;
      errorEl.textContent = '';
    } else {
      errorEl.hidden = false;
      errorEl.textContent = message;
    }
  }

  function updateContactStats() {
    const pending = contactRequestsCache.filter((item) => !item.processed).length;
    const total = contactRequestsCache.length;
    const pendingEl = document.getElementById('statContacts');
    const totalEl = document.getElementById('statContactsTotal');

    if (pendingEl) pendingEl.textContent = pending;
    if (totalEl) totalEl.textContent = `Total ${total}`;
  }

  function renderContactList(requests = []) {
    const list = document.getElementById('adminContacts');
    const emptyEl = document.getElementById('contactsEmpty');
    if (!list) return;

    list.innerHTML = '';

    if (!requests.length) {
      if (emptyEl) emptyEl.hidden = false;
      return;
    }

    if (emptyEl) emptyEl.hidden = true;

    requests.forEach((request) => {
      const card = document.createElement('article');
      card.className = 'admin-contact-card';
      card.setAttribute('role', 'listitem');

      const badgeClass = request.processed ? 'processed' : 'pending';
      const badgeLabel = request.processed ? 'Trait√©e' : '√Ä rappeler';
      const toggleLabel = request.processed ? 'Marquer √† rappeler' : 'Marquer comme trait√©e';
      const buttonColor = request.processed ? '#607D8B' : '#2e7d32';

      card.innerHTML = `
        <header>
          <div>
            <h3>${escapeHtml(`${request.firstname || ''} ${request.lastname || ''}`.trim() || 'Contact')}</h3>
            <p class="admin-contact-meta">Re√ßu le ${escapeHtml(formatContactDate(request.created_at))}</p>
          </div>
          <span class="admin-contact-badge ${badgeClass}">${badgeLabel}</span>
        </header>
        <div class="admin-contact-body">
          <span>Email : <a href="mailto:${escapeHtml(request.email || '')}">${escapeHtml(request.email || '')}</a></span>
          <span>T√©l√©phone : <a href="${formatPhoneHref(request.phone || '')}">${escapeHtml(request.phone || '')}</a></span>
          ${request.preferred_time ? `<span>Cr√©neau souhait√© : ${escapeHtml(request.preferred_time)}</span>` : ''}
        </div>
        <div class="admin-contact-actions">
          <button type="button" class="btn" data-contact-toggle="${request.id}" data-processed="${request.processed ? 'true' : 'false'}" style="background:${buttonColor};">${toggleLabel}</button>
        </div>
      `;

      list.appendChild(card);
    });
  }

  async function loadContacts({ showLoader = true } = {}) {
    const loadingEl = document.getElementById('contactsLoading');
    const emptyEl = document.getElementById('contactsEmpty');

    if (loadingEl) loadingEl.hidden = !showLoader ? true : false;
    if (emptyEl) emptyEl.hidden = true;
    showContactsError('');

    const { data, error } = await supabase
      .from('contacts')
      .select('*')
      .order('processed', { ascending: true })
      .order('created_at', { ascending: false });

    if (loadingEl) loadingEl.hidden = true;

    if (error) {
      console.error(error);
      showContactsError("Impossible de r√©cup√©rer les demandes de contact.");
      contactRequestsCache = [];
      renderContactList([]);
      updateContactStats();
      return;
    }

    contactRequestsCache = Array.isArray(data) ? data : [];
    renderContactList(contactRequestsCache);
    updateContactStats();
  }

  // Helpers de statut
  function isReserved(car = {}) {
    if (!car || typeof car !== 'object') return false;
    if (typeof car.reserve === 'boolean') return car.reserve;
    if (typeof car.reserved === 'boolean') return car.reserved;
    const status = car.status || car.statut;
    if (typeof status === 'string') {
      const normalized = status.toLowerCase();
      return normalized.includes('reserv');
    }
    return false;
  }

  function updateDashboardStats(cars = []) {
    const total = cars.length;
    const sold = cars.filter((car) => car.vendu).length;
    const reserved = cars.filter((car) => isReserved(car)).length;
    const available = cars.filter((car) => !car.vendu && !isReserved(car)).length;

    const totalEl = document.getElementById('statTotal');
    const availableEl = document.getElementById('statAvailable');
    const soldEl = document.getElementById('statSold');
    const reservedEl = document.getElementById('statReserved');

    if (totalEl) totalEl.textContent = total;
    if (availableEl) availableEl.textContent = available;
    if (soldEl) soldEl.textContent = sold;
    if (reservedEl) reservedEl.textContent = reserved;
  }

  function getFilteredCars() {
    const search = adminFilters.search ? adminFilters.search.trim().toLowerCase() : '';
    const status = adminFilters.status;

    return adminCarsCache.filter((car) => {
      let matchesSearch = true;
      if (search) {
        const haystack = [
          car.marque,
          car.modele,
          car.annee,
          car.kilometrage,
          car.motorisation,
          car.carburant,
        ]
          .filter(Boolean)
          .join(' ')
          .toLowerCase();

        matchesSearch = haystack.includes(search);
      }

      if (!matchesSearch) return false;

      if (status === 'available') {
        return !car.vendu && !isReserved(car);
      }
      if (status === 'sold') {
        return !!car.vendu;
      }
      if (status === 'reserved') {
        return isReserved(car);
      }

      return true;
    });
  }

  function renderAdminList(cars = [], { onEdit } = {}) {
    const container = document.getElementById('adminCars');
    if (!container) return;

    currentOnEditCallback = onEdit || currentOnEditCallback;
    const editCallback = currentOnEditCallback;

    if (!adminCarsCache.length) {
      container.innerHTML = '<p>Aucun v√©hicule enregistr√© pour le moment.</p>';
      return;
    }

    if (!cars.length) {
      container.innerHTML = '<p>Aucun v√©hicule ne correspond √† vos filtres pour le moment.</p>';
      return;
    }

    container.innerHTML = '';

    cars.forEach((v) => {
      const div = document.createElement('div');
      div.style.padding = '10px 12px';
      div.style.border = '1px solid #eee';
      div.style.borderRadius = '10px';
      div.style.marginBottom = '8px';
      div.style.display = 'flex';
      div.style.justifyContent = 'space-between';
      div.style.alignItems = 'center';
      div.style.gap = '10px';

      const badges = [];
      if (v.vendu) {
        badges.push('<span style="margin-left:8px;padding:2px 8px;border-radius:999px;background:#fce4e4;color:#b30000;font-size:.8rem;">Vendu</span>');
      }
      if (isReserved(v)) {
        badges.push('<span style="margin-left:8px;padding:2px 8px;border-radius:999px;background:#fff4d8;color:#bfa16a;font-size:.8rem;">R√©serv√©</span>');
      }

      div.innerHTML = `
        <div style="flex:1;">
          <strong>${v.marque} ${v.modele}</strong>
          <span style="color:#777;font-size:.9rem;">
            ‚Ä¢ ${v.annee} ‚Ä¢ ${Number(v.kilometrage).toLocaleString('fr-FR')} km
          </span>
          ${
            v.motorisation || v.chevaux
              ? `<div style="font-size:.85rem;color:#555;margin-top:4px;">
                  ${v.motorisation ? `${v.motorisation}` : ''}
                  ${v.motorisation && v.chevaux ? ' ‚Ä¢ ' : ''}
                  ${v.chevaux ? `${v.chevaux} ch` : ''}
                </div>`
              : ''
          }
          ${badges.join(' ')}
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button
            class="btn"
            style="padding:6px 10px;font-size:.8rem;background:#607D8B;"
            data-action="edit"
            data-id="${v.id}"
          >
            Modifier
          </button>
          <button
            class="btn"
            style="padding:6px 10px;font-size:.8rem;${v.vendu ? 'background:#4caf50;' : 'background:#bfa16a;'}"
            data-action="toggle-sold"
            data-id="${v.id}"
          >
            ${v.vendu ? 'Remettre en vente' : 'Marquer comme vendu'}
          </button>
          <button
            class="btn"
            style="padding:6px 10px;font-size:.8rem;background:#c62828;"
            data-action="delete"
            data-id="${v.id}"
          >
            Supprimer
          </button>
        </div>
      `;

      container.appendChild(div);
    });

    if (editCallback) {
      container.querySelectorAll('button[data-action="edit"]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          const car = adminCarsCache.find((c) => String(c.id) === String(id));
          if (car) editCallback(car);
        });
      });
    }

    container.querySelectorAll('button[data-action="toggle-sold"]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        const car = adminCarsCache.find((c) => String(c.id) === String(id));
        if (!car) return;
        await setCarSold(id, !car.vendu);
      });
    });

    container.querySelectorAll('button[data-action="delete"]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        if (confirm('Supprimer d√©finitivement ce v√©hicule ?')) {
          await deleteCar(id);
        }
      });
    });
  }
  
  // Charge la liste des v√©hicules pour l‚Äôadmin
  async function loadAdminCars({ onEdit } = {}) {
    const container = document.getElementById('adminCars');
    if (!container) return;
  
    const { data, error } = await supabase
      .from('voitures')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      console.error(error);
      container.innerHTML = '<p>Erreur lors du chargement des v√©hicules.</p>';
      return;
    }

    adminCarsCache = data || [];
    galleryColumnDetected = (data || []).some((v) => Object.prototype.hasOwnProperty.call(v, 'gallery_urls'));
    currentOnEditCallback = onEdit || currentOnEditCallback;

    if (!adminCarsCache.length) {
      updateDashboardStats([]);
      container.innerHTML = '<p>Aucun v√©hicule enregistr√© pour le moment.</p>';
      return;
    }

    updateDashboardStats(adminCarsCache);
    renderAdminList(getFilteredCars(), { onEdit: currentOnEditCallback });
  }
  
  // Met √† jour le statut vendu
  async function setCarSold(id, isSold) {
    const { error } = await supabase
      .from('voitures')
      .update({ vendu: isSold })
      .eq('id', id);
  
    if (error) {
      alert("Erreur lors de la mise √† jour du statut.");
      console.error(error);
    } else {
      loadAdminCars(); // pas besoin de callback ici, juste refresh visuel
    }
  }
  
  // Supprime un v√©hicule
  async function deleteCar(id) {
    const { error } = await supabase
      .from('voitures')
      .delete()
      .eq('id', id);
  
    if (error) {
      alert("Erreur lors de la suppression.");
      console.error(error);
    } else {
      loadAdminCars();
    }
  }
  
  // Lancement
  checkSession();
</script>
</body>
</html>
